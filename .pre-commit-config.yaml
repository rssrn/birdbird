repos:
  - repo: local
    hooks:
      # Frontend linting (fast, file-scoped)
      - id: html-validate
        name: HTML validation (html-validate)
        entry: npx html-validate
        language: system
        files: \.html$
        types: [file]
      - id: eslint
        name: JavaScript validation (eslint)
        entry: npx eslint --no-warn-ignored
        language: system
        files: \.(html|js)$
        types: [file]
      - id: stylelint
        name: CSS validation (stylelint)
        entry: npx stylelint --allow-empty-input
        language: system
        files: \.(css|html)$
        types: [file]
      - id: cspell
        name: Spell check (cspell)
        entry: npx cspell --no-progress --no-summary
        language: system
        files: \.(html|md)$
        types: [file]
      # Python style (fast, file-scoped)
      - id: ruff
        name: Lint (ruff)
        entry: .venv/bin/ruff check --fix
        language: system
        types: [python]
      - id: ruff-format
        name: Format (ruff)
        entry: .venv/bin/ruff format
        language: system
        types: [python]
      # Python analysis (slower, project-scoped)
      - id: bandit
        name: Security lint (bandit)
        entry: .venv/bin/bandit -r src/birdbird/ -q -c pyproject.toml
        language: system
        types: [python]
        pass_filenames: false
      - id: mypy
        name: Type checking (mypy)
        entry: .venv/bin/mypy src/birdbird
        language: system
        types: [python]
        pass_filenames: false
      - id: pytest
        name: Tests (pytest)
        entry: .venv/bin/pytest
        language: system
        pass_filenames: false
        types: [python]
      # Pre-push only (slowest)
      - id: a11y
        name: Accessibility testing (pa11y)
        entry: bash -c 'PORT=$(python3 -c "import socket; s=socket.socket(); s.bind((\"\",0)); print(s.getsockname()[1]); s.close()"); npx serve -l $PORT src/birdbird/templates &>/dev/null & SERVER_PID=$!; sleep 2; PORT=$PORT npm run test:a11y; EXIT=$?; kill $SERVER_PID 2>/dev/null; exit $EXIT'
        language: system
        stages: [pre-push]
        files: \.(html|css|js)$
        pass_filenames: false
      - id: pip-audit
        name: Security audit (pip-audit)
        # CVE-2026-1669 (keras): no fix available; transitive dep via birdnet-analyzer->tensorflow->keras; not loading untrusted models
        entry: bash -c 'MARKER=.venv/.pip-audit-last-run; if [ -f "$MARKER" ] && [ "$(date -r "$MARKER" +%Y%m%d)" = "$(date +%Y%m%d)" ]; then echo "pip-audit already ran today, skipping"; exit 0; fi; .venv/bin/pip-audit --vulnerability-service osv --skip-editable --ignore-vuln CVE-2026-1669 && touch "$MARKER"'
        language: system
        stages: [pre-push]
        always_run: true
        pass_filenames: false
